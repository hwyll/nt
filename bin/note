#!/usr/bin/env bash

# note - Quick note-taking CLI
# Compatible with macOS (BSD tools)

set -o pipefail

VERSION="3.0.0"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="$SCRIPT_DIR"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

# Global flags (used by commands.sh)
NOTE_QUIET=false
NOTE_YES=false

source "$LIB_DIR/config.sh"
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/parser.sh"
source "$LIB_DIR/writer.sh"
source "$LIB_DIR/format.sh"
source "$LIB_DIR/display.sh"
source "$LIB_DIR/commands.sh"

# Quiet-aware output
output() { $NOTE_QUIET || echo "$@"; }

main() {
  load_config
  
  # Enable colors for TTY or fzf (--ansi)
  [ -t 1 ] && FORCE_COLOR=true
  
  # No arguments - interactive browser
  [ $# -eq 0 ] && { FORCE_COLOR=true; interactive_browse; exit 0; }
  
  # Parse flags
  local mode="note" tags="" format="plain" filter_tag="" since="" target=""
  local today=false
  local args=()
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help) show_help; exit 0 ;;
      -v|--version) echo "note v$VERSION"; exit 0 ;;
      -q|--quiet) NOTE_QUIET=true; shift ;;
      -y|--yes) NOTE_YES=true; shift ;;
      
      # List / Query
      --tags) mode="tags"; shift ;;
      -l|--list) mode="list"; shift ;;
      -s|--search) [ -z "$2" ] && error "-s requires search term" && exit 1; mode="search"; target="$2"; shift 2 ;;
      --today) today=true; shift ;;
      --since) [ -z "$2" ] && error "--since requires date" && exit 1; since="$2"; shift 2 ;;
      --tag) [ -z "$2" ] && error "--tag requires tag name" && exit 1; filter_tag="$2"; shift 2 ;;
      -f|--format) [ -z "$2" ] && error "-f requires format" && exit 1; format="$2"; shift 2 ;;
      
      # Note creation
      -t) [ -z "$2" ] && error "-t requires tags" && exit 1; tags="$2"; shift 2 ;;
      -e|--edit)
        if [[ -n "$2" && ( "$2" =~ ^-[0-9]+$ || "$2" != -* ) ]]; then
          mode="edit"; target="$2"; shift 2
        else
          mode="editor"; shift
        fi ;;
      
      # Operations
      -c|--comment) [ -z "$2" ] && error "-c requires note ID" && exit 1; mode="comment"; target="$2"; shift 2 ;;
      -g|--retag) [ -z "$2" ] && error "-g requires note ID" && exit 1; mode="tag"; target="$2"; shift 2 ;;
      -d|--delete) [ -z "$2" ] && error "-d requires note ID" && exit 1; mode="delete"; target="$2"; shift 2 ;;
      -x|--export) mode="export"; shift ;;
      
      --) shift; args+=("$@"); break ;;
      -*) error "Unknown option: $1"; exit 1 ;;
      *) args+=("$1"); shift ;;
    esac
  done
  
  # Execute
  case "$mode" in
    note)
      [[ ${#args[@]} -eq 0 || -z "${args[*]// }" ]] && error "Note content required" && exit 1
      local note_id=$(create_note "${args[*]}" "$tags" "")
      output "Note created: $note_id" ;;
    editor)
      local note_id=$(create_note_with_editor "${args[*]}" "$tags")
      output "Note created: $note_id" ;;
    list)
      [ ${#args[@]} -gt 0 ] && error "Unexpected argument: ${args[0]} (use --since for date filters)" && exit 1
      $today && since="$(date +%Y-%m-%d)"
      cmd_list --format "$format" ${filter_tag:+--tag "$filter_tag"} ${since:+--since "$since"} ;;
    tags)
      [ ${#args[@]} -gt 0 ] && error "Unexpected argument: ${args[0]}" && exit 1
      cmd_tags ;;
    search)
      interactive_find "$target" ;;
    edit)
      cmd_edit "$target" ;;
    comment)
      [ ${#args[@]} -eq 0 ] && error "Comment text required" && exit 1
      cmd_comment "$target" "${args[*]}" ;;
    tag)
      [ ${#args[@]} -eq 0 ] && error "Tag modification required" && exit 1
      cmd_tag "$target" "${args[*]}" ;;
    delete)
      [ ${#args[@]} -gt 0 ] && error "Unexpected argument: ${args[0]}" && exit 1
      cmd_delete "$target" ;;
    export)
      [ ${#args[@]} -gt 0 ] && error "Unexpected argument: ${args[0]} (use --since for date filters)" && exit 1
      cmd_export --format "$format" ${filter_tag:+--tag "$filter_tag"} ${since:+--since "$since"} ;;
  esac
}

show_help() {
  cat << 'EOF'
note v3.0.0 - Quick note-taking

USAGE:
  note [OPTIONS] [TEXT]

CAPTURE:
  note buy potato                Quick note
  note -t work,urgent task       Note with tags
  note -e                        New note in editor
  note -e latest                 Edit existing note

LIST / SEARCH:
  note                           Interactive browser (fzf)
  note -l                        List all notes
  note -l --today                List today's notes
  note -l --tag work             Filter by tag
  note -l --since 2026-01-01     Filter by date
  note -l --since yesterday      Relative dates work too
  note -l -f json                Output format (json|csv|md|plain)
  note -s "term"                 Search notes
  note --tags                    List all tags

OPERATIONS:
  note -c <id> "text"            Add comment
  note -g <id> +tag -tag         Modify tags
  note -d <id>                   Delete note
  note -y -d <id>                Delete without confirm

EXPORT:
  note -x                        Export as markdown
  note -x -f json --tag work     Export filtered as JSON

OPTIONS:
  -t TAGS              Tags for new note (comma-separated)
  -e [ID]              Edit note (or new in editor if no ID)
  -l, --list           List notes
  -s, --search TERM    Search notes
  -c, --comment ID     Add comment to note
  -g, --retag ID       Modify note tags
  -d, --delete ID      Delete note
  -x, --export         Export notes
  -f, --format FMT     Output format
  -q, --quiet          Suppress output messages
  -y, --yes            Skip confirmation prompts
  --tags               List all tags
  --today              Filter to today
  --since DATE         Filter by date (YYYY-MM-DD, yesterday, 'last week')
  --tag TAG            Filter by tag
  -h, --help           Help
  -v, --version        Version

NOTE IDS:
  Full:      20260203143052
  Time only: 143052 (today)
  Relative:  latest, oldest, -1, -2

ESCAPING:
  note -- -t not a flag       Use -- to escape flag-like content
EOF
}

main "$@"
